<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Campus Bites | Menu</title>
  <link rel="icon" href="img/core-img/campus-bites.jpg">
  <link href="style.css" rel="stylesheet">
  <link href="css/responsive/responsive.css" rel="stylesheet">
  <style>
    header { background-color: white; margin-bottom: 40px; }
    h2.menu-heading { text-align:center; margin:40px 0 20px; color:#D62300; font-weight:600; }
    .menu-item img { height:150px; object-fit:cover; border-radius:10px; }
    .menu-item .btn-review { margin-top:8px; }
  </style>
</head>
<body>

  <!-- ****** Top Header Area Start ****** -->
    <div class="top_header_area">
        <div class="container">
            <div class="row">
               
                <div class="col-7 col-sm-6">
                    <div class="signup-search-area d-flex align-items-center justify-content-end">
                     <!-- Search Button Area -->
<div class="search_button">
  <a class="searchBtn" href="#"><i class="fa fa-search" aria-hidden="true"></i></a>
</div>

<!-- Search Form -->
<div class="search-hidden-form" style="display: none;">
  <form action="#" method="get">
    <input type="search" name="search" id="search-anything" placeholder="Search Anything...">
    <input type="submit" value="" class="d-none">
    <span class="searchBtn"><i class="fa fa-times" aria-hidden="true"></i></span>
  </form>
</div>

                        








                    </div>
                </div>
            </div>
        </div>
    </div>
  <header class="header_area">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <div class="logo_area text-center" style="display: flex; align-items: center; justify-content: center; gap: 15px;">
            <img src="img/bg-img/canteen review logo (white).jpg" alt="logo" style="height: 90px; width: auto; object-fit: contain;">
            <a href="home.html" class="yummy-logo" style="font-size: 46px; text-decoration: none; color: #000; font-weight: 500;">Campus Bites</a>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <nav class="navbar navbar-expand-lg">
  <div class="container-fluid d-flex align-items-center justify-content-between">

    <!-- Left (Toggler button) -->
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#yummyfood-nav"
      aria-controls="yummyfood-nav" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fa fa-bars" aria-hidden="true"></i> Menu
    </button>

    <!-- Centered Menu -->
    <div class="collapse navbar-collapse justify-content-center" id="yummyfood-nav">
      <ul class="navbar-nav" id="yummy-nav">
        <li class="nav-item"><a class="nav-link" href="home.html">Home</a></li>
        <li class="nav-item active"><a class="nav-link" href="branch.html">Branch</a></li>
        <li class="nav-item"><a class="nav-link" href="events.html">Events</a></li>
        <li class="nav-item"><a class="nav-link" href="polls.html">Poll</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Leaderboard</a></li>
        <li class="nav-item"><a class="nav-link" href="profile.html">Profile</a></li>
      </ul>
    </div>

    <!-- Rightmost Wishlist -->
    <div class="navbar-right">
      <a class="nav-link" href="wishlist1.html" style="font-size: larger;">♡</a>
    </div>

  </div>
</nav>

        </div>
      </div>
    </div>
  </header>

<!-- MENU SECTIONS (empty — will be filled from Firestore) -->
<h2 class="menu-heading">Breakfast</h2>
<section class="register" style="background:#fff8f3;">
  <div class="container"><div class="row g-4" id="breakfast-items"></div></div>
</section>

<h2 class="menu-heading">South Indian</h2>
<section class="register" style="background:#fff8f3;">
  <div class="container"><div class="row g-4" id="south-indian-items"></div></div>
</section>

<h2 class="menu-heading">Chinese</h2>
<section class="register" style="background:#fff8f3;">
  <div class="container"><div class="row g-4" id="chinese-items"></div></div>
</section>

<h2 class="menu-heading">Chaat</h2>
<section class="register" style="background:#fff8f3;">
  <div class="container"><div class="row g-4" id="chaat-items"></div></div>
</section>

<h2 class="menu-heading">Beverages</h2>
<section class="register" style="background:#fff8f3;">
  <div class="container"><div class="row g-4" id="beverages-items"></div></div>
</section>

<footer class="footer_area py-4" style="background-color:#fff8f5;border-top:1px solid #eee;">
  <div class="container text-center">
    <p>© Campus Bites</p>
  </div>
</footer>

<script src="js/jquery/jquery-2.2.4.min.js"></script>
<script src="js/bootstrap/bootstrap.min.js"></script>
<script src="js/others/plugins.js"></script>
<script src="js/active.js"></script>

<!-- DYNAMIC FIREBASE LOADER + CATEGORY FIX + WISHLIST & REVIEW HOOKS -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // your firebase config (same as admin)
  const firebaseConfig = {
    apiKey: "AIzaSyBy5yfr3yYuMSDFHWwp0LdRhQASe2EKx78",
    authDomain: "campusbites-a7d47.firebaseapp.com",
    projectId: "campusbites-a7d47",
    storageBucket: "campusbites-a7d47.appspot.com",
    messagingSenderId: "287799383807",
    appId: "1:287799383807:web:80dcc43f75b5e226241eca"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // heuristic to infer category from item name when category is 'misc' or wrong
  function inferCategoryFromName(name) {
    if (!name) return 'misc';
    const s = name.toLowerCase();

    // CHOICES: breakfast, south-indian, chinese, chaat, beverages
    const chaatKeywords = ['puri','bhel','chaat','sev','pani','vada','batata','dahi','pav','chowpatty'];
    const southKeywords = ['idli','dosa','uttapam','medu','masala','sada','shezwan dosa','sada dosa','cheese dosa'];
    const chineseKeywords = ['noodle','rice','manchurian','schezwan','chilli','crispy','fried rice','hakka','manch'];
    const beverageKeywords = ['tea','coffee','juice','chocolate','water','cold coffee','milkshake'];
    const breakfastKeywords = ['toast','poha','pav','missal','butter','breakfast','sandwich'];

    if (chaatKeywords.some(k => s.includes(k))) return 'chaat';
    if (southKeywords.some(k => s.includes(k))) return 'south-indian';
    if (chineseKeywords.some(k => s.includes(k))) return 'chinese';
    if (beverageKeywords.some(k => s.includes(k))) return 'beverages';
    if (breakfastKeywords.some(k => s.includes(k))) return 'breakfast';

    // fallback: if name contains numbers/prices? no — default to breakfast for many short names
    return 'breakfast';
  }

  // attach wishlist listeners to .add-to-wishlist buttons (replaces older functions if not defined)
  function attachWishlistEvents() {
    const wishlistKey = 'wishlist1';
    document.querySelectorAll('.add-to-wishlist').forEach(button => {
      // avoid duplicate handlers
      if (button.dataset.wishlistAttached === "1") return;
      button.dataset.wishlistAttached = "1";

      button.addEventListener('click', function (e) {
        e.preventDefault();
        const item = {
          id: this.getAttribute('data-id'),
          name: this.getAttribute('data-name'),
          price: this.getAttribute('data-price'),
          img: this.getAttribute('data-img')
        };

        let wishlist = JSON.parse(localStorage.getItem(wishlistKey)) || [];
        const exists = wishlist.some(i => i.name === item.name);
        if (!exists) {
          wishlist.push(item);
          localStorage.setItem(wishlistKey, JSON.stringify(wishlist));
          alert(`${item.name} added to wishlist ❤️`);
        } else {
          alert(`${item.name} is already in wishlist!`);
        }
      });
    });
  }

  // Add Post Reviews button for each loaded item (tries to use existing modal + loadReviews if present)
  function addReviewButtons() {
    document.querySelectorAll('.menu-item').forEach(card => {
      if (card.dataset.reviewAttached === "1") return;
      card.dataset.reviewAttached = "1";

      // create button
      const btn = document.createElement('button');
      btn.className = 'btn btn-outline-dark w-100 mt-2 btn-review';
      btn.textContent = 'Post Reviews';
      btn.addEventListener('click', () => {
        // find title
        const titleEl = card.querySelector('h4, h5, .card-title');
        const itemName = titleEl ? titleEl.innerText.trim() : '';

        // if your modal exists and a function loadReviews is present, call it
        if (document.getElementById('viewReviewsModal')) {
          // set modal title if present
          const dishTitleEl = document.getElementById('dishTitle');
          if (dishTitleEl) dishTitleEl.textContent = itemName;

          // call your loadReviews(itemName) if defined globally
          if (typeof loadReviews === 'function') {
            loadReviews(itemName);
          }

          // open the bootstrap modal if bootstrap is loaded
          try {
            const modalEl = document.getElementById('viewReviewsModal');
            if (modalEl) {
              const m = new bootstrap.Modal(modalEl);
              m.show();
            }
          } catch (err) {
            console.warn('Could not open bootstrap modal:', err);
          }
        } else {
          // fallback: if modal not present, just alert
          alert(`Reviews for "${itemName}". (No review modal found on this page.)`);
        }
      });

      // append below existing wishlist button
      const cardBody = card.querySelector('.card-body') || card;
      cardBody.appendChild(btn);
    });
  }

  // Main loader: normalize categories, infer for misc, and render items
  async function loadMenu() {
    const snap = await getDocs(collection(db, "menuItems"));

    // clear any existing content (safe to call multiple times)
    ['breakfast','south-indian','chinese','chaat','beverages'].forEach(cat => {
      const el = document.getElementById(`${cat}-items`);
      if (el) el.innerHTML = '';
    });

    snap.forEach(docSnap => {
      const item = docSnap.data();
      let category = (item.category || '').toString().toLowerCase().trim();

      // if category is empty or misc-like, try to infer from name
      if (!category || category === 'misc' || category === 'miscellaneous') {
        category = inferCategoryFromName(item.name || '');
        console.log(`Inferred category for "${item.name}" → ${category}`);
      }

      // normalize final category (only allow our 5 categories)
      const allowed = ['breakfast','south-indian','chinese','chaat','beverages'];
      if (!allowed.includes(category)) {
        // try to normalize spaces/hyphens
        const alt = category.replace(/\s+/g,'-');
        if (allowed.includes(alt)) category = alt;
        else {
          // as last resort, infer from name
          category = inferCategoryFromName(item.name || '');
        }
      }

      const container = document.getElementById(`${category}-items`);
      if (!container) {
        console.warn('No container for category', category, ' — item:', item.name);
        return;
      }

      container.insertAdjacentHTML('beforeend', `
        <div class="col-lg-4 col-md-6 menu-item">
          <div class="card shadow-lg border-0 rounded-4">
            <div class="card-body p-4 text-center">
              <h4 class="text-danger">${escapeHtml(item.name)}</h4>
              <p>Price: ₹${escapeHtml(String(item.price || '—'))}</p>
              <img src="${escapeHtml(item.img || 'img/core-img/campus-bites.jpg')}" class="img-fluid mb-3" alt="${escapeHtml(item.name)}">
              <button class="btn btn-outline-danger w-100 add-to-wishlist"
                data-id="${docSnap.id}"
                data-name="${escapeHtml(item.name)}"
                data-price="${escapeHtml(String(item.price || ''))}"
                data-img="${escapeHtml(item.img || '')}">
                ♡ Add to Wishlist
              </button>
            </div>
          </div>
        </div>
      `);
    });

    // attach wishlist + review handlers after DOM injection
    attachWishlistEvents();
    addReviewButtons();
  }

  // small helper to avoid HTML injection
  function escapeHtml(text) {
    return String(text)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // run it
  loadMenu().catch(err => console.error('LoadMenu error:', err));

  // OPTIONAL: expose loadMenu globally so admin UI can call it after updates
  window.reloadMenuFromFirestore = loadMenu;

  // DEBUG helper: show exact categories fetched (call in console: window.printCategories())
  window.printCategories = async function() {
    const s = await getDocs(collection(db, "menuItems"));
    console.log('--- categories ---');
    s.forEach(d => console.log(d.data().name, '→', d.data().category));
  };
</script>

</body>
</html>
