<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Campus Bites | Admin</title>
  <link rel="icon" href="img/core-img/campus-bites.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/yourkitid.js" crossorigin="anonymous"></script>

  <style>
    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      display: flex;
      background: #f3f4f6;
      color:  #d62300;
      min-height: 100vh;
    }
    .sidebar {
      position: relative;
      width: 250px;
      background: #d62300;
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }
    .sidebar h2 {
      margin: 0 0 20px;
      text-align: center;
    }
    .sidebar a {
      font-family: sans-serif;
      color: #cbd5e1;
      text-decoration: none;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      display: block;
    }
    .sidebar a.active, .sidebar a:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    .content {
      flex: 1;
      padding: 30px;
    }
    .panel {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      max-width: 900px;
      margin: 0 auto;
    }
    .cards {
  display: flex;
  gap: 20px;
  margin-bottom: 25px;
  flex-wrap: wrap;
  
}

.card {
  background:  #d62300;
  border-radius: 12px;
  padding: 20px;
  color: #fff;
  width: 220px;
  text-align: center;
  cursor: pointer;
  transition: transform 0.2s ease, background 0.3s ease;
}

.card:hover {
  transform: translateY(-4px);
  background: red;
}

.value {
  font-size: 28px;
  font-family: sans-serif;
  font-weight: 700;
  margin-top: 8px;
  color: white;
}

.history-section {
  display: none;
  margin-top: 30px;
  background: #f3f4f6;
  border-radius: 10px;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

.history-section h3 {
  margin-bottom: 15px;
  color: #d62300;
}

.history-item {
  background: #fff;
  border-radius: 8px;
  padding: 14px 16px;
  margin-bottom: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  transition: transform 0.2s ease;
}

.history-item:hover {
  transform: translateX(4px);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

    input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 14px;
    }
    button {
      background: #d62300;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { opacity: 0.9; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px;
      text-align: left;
    }
    th {
      color: #6b7280;
      font-size: 13px;
    }
.admin-profile {
  position: absolute;
  bottom: 20px;
  left: 12px;
  right: 12px;
  background:  #d62300;
  border-radius: 10px;
  padding: 10px 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  transition: background 0.2s ease;
  width: auto;
}


.profile-main {
  display: flex;
  align-items: center;
  gap: 10px;
}

.profile-avatar {
  background: #ff6600;
  color: #fff;
  font-weight: 700;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}

.profile-info {
  display: flex;
  flex-direction: column;
}

.profile-name {
  font-weight: 600;
  font-size: 14px;
  color: #fff;
}

.profile-email {
  font-size: 12px;
  color: #cbd5e1;
}

.profile-dropdown {
  display: none;
  background: #d62300;
  position: absolute;
  bottom: 70px;
  left: 0;
  right: 0;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 6px 12px rgba(0,0,0,0.2);
  animation: fadeIn 0.2s ease-in-out;
}

.profile-dropdown div {
  padding: 10px 14px;
  color: #fff;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
}

.profile-dropdown div:hover {
  background: rgba(255,255,255,0.1);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

  </style>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body onload="updateDashboardCounts()">

  <aside class="sidebar">
    <h2>Campus Bites</h2>
    <a href="#" class="active" onclick="showPage('dashboard', event)"><i class="fa fa-index"></i> Dashboard</a>
    <a href="#" onclick="showPage('events', event)"><i class="fa fa-calendar"></i> Upload Events</a>
    <a href="#" onclick="showPage('polls', event)"><i class="fa fa-poll"></i> Upload Polls</a>
    <a href="#" onclick="showPage('users', event)"><i class="fa fa-users"></i> Users</a>
    <div class="admin-profile" id="adminProfile">
  <div class="profile-main">
    <div class="profile-avatar">A</div>
    <div class="profile-info">
      <div class="profile-name">Admin</div>
      <div class="profile-email">admin@campusbites.com</div>
      
     
    </div>
  </div>

  <div class="profile-dropdown" id="profileDropdown">
    <div onclick="editDetails()"><i class="fa fa-edit"></i> Edit Details</div>
    <div onclick="switchAccount()"><i class="fa fa-exchange-alt"></i> Switch Account</div>
    <div onclick="logoutAdmin()"><i class="fa fa-sign-out-alt"></i> Logout</div>
  </div>
</div>

</div>

  

  </aside>

  <main class="content">
<section id="page-dashboard" class="page">
  <div class="cards">
    <div class="card" id="eventsCard" onclick="showHistory('events')">
      <h3>Total Events</h3>
      <div class="value" id="statEvents">0</div>
    </div>
    <div class="card" id="pollsCard" onclick="showHistory('polls')">
      <h3>Total Polls</h3>
      <div class="value" id="statPolls">0</div>
    </div>
    <div class="card" id="usersCard">
      <h3>Total Users</h3>
      <div class="value" id="statUsers">0</div>
    </div>
  </div>

  <div class="panel">
    <h3>Welcome, Admin!</h3>
    <p>Use the sidebar to manage events, polls, and users.</p>
  </div>

  <!-- Hidden history area -->
  <div class="history-section" id="historySection">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3 id="historyTitle">History</h3>
      <button onclick="closeHistory()" 
        style="background:none;border:none;color:#111827;font-size:18px;cursor:pointer;
               padding:4px 8px;border-radius:6px;transition:background 0.2s;">
        ‚úñ
      </button>
    </div>
    <div id="historyList"></div>
  </div>
</section>
    <!-- Upload Events -->
    <section id="page-events" class="page" style="display:none;">
      <div class="panel">
        <h3>Upload Event</h3>
        <input id="eventTitle" placeholder="Event Title" />
        <input id="eventDate" type="date" />
        <textarea id="eventDesc" placeholder="Event Description"></textarea>
        <button onclick="uploadEvent()">Upload Event</button>
      </div>
    </section>
    <!--Upload Polls-->

<section id="page-polls" class="page" style="display:none;">
  <div class="panel">
    <h3>Create Poll</h3>
    <input id="pollQuestion" placeholder="Poll Question" oninput="updatePollPreview()" />
    <textarea id="pollOptions" placeholder="Enter options separated by commas" oninput="updatePollPreview()"></textarea>
    <button onclick="uploadPoll()">Upload Poll</button>
    <div id="previewPoll" style="margin-top: 20px;"></div>


    
  </div>
</section>
    <!-- Users -->
    <section id="page-users" class="page" style="display:none;">
      <div class="panel">
        <h3>Registered Users</h3>
        <button onclick="loadUsers()">Refresh</button>
        <table>
          <thead>
            <tr><th>Name</th><th>Email</th><th>Role</th></tr>
          </thead>
          <tbody id="usersTableBody"></tbody>
        </table>
      </div>
    </section>
  </main>
<script type="module">
  /* ========= FIREBASE IMPORTS ========= */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { 
    getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, getDoc 
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { 
    getAuth, onAuthStateChanged, updateProfile, signOut 
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  /* ========= ‚öôÔ∏è FIREBASE CONFIG ========= */
  const firebaseConfig = {
    apiKey: "AIzaSyBy5yfr3yYuMSDFHWwp0LdRhQASe2EKx78",
    authDomain: "campusbites-a7d47.firebaseapp.com",
    projectId: "campusbites-a7d47",
    storageBucket: "campusbites-a7d47.firebasestorage.app",
    messagingSenderId: "287799383807",
    appId: "1:287799383807:web:80dcc43f75b5e226241eca"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  /* ========= DASHBOARD STATS ========= */
  async function updateDashboardCounts() {
    try {
      const eventsSnap = await getDocs(collection(db, "events"));
      const pollsSnap = await getDocs(collection(db, "polls"));
      const usersSnap = await getDocs(collection(db, "users"));

      document.getElementById("statEvents").textContent = eventsSnap.size;
      document.getElementById("statPolls").textContent = pollsSnap.size;
      document.getElementById("statUsers").textContent = usersSnap.size;
    } catch (err) {
      console.error("Error loading dashboard counts:", err);
    }
  }

  /* ========= HISTORY (EVENTS / POLLS) ========= */
  async function showHistory(type) {
    const section = document.getElementById("historySection");
    const title = document.getElementById("historyTitle");
    const list = document.getElementById("historyList");

    section.style.display = "block";
    list.innerHTML = "<p>Loading...</p>";

    try {
      const snapshot = await getDocs(collection(db, type));
      if (snapshot.empty) {
        list.innerHTML = `<p>No ${type} available.</p>`;
        return;
      }

      list.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.classList.add("history-item");
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <strong>${type === "events" ? data.title : data.question}</strong><br>
              ${type === "events" ? `<span style='color:#ff6600'>${data.date}</span><br><small>${data.description}</small>` 
                                  : `<small>Options: ${data.options?.join(", ") || "N/A"}</small>`}
            </div>
            <button class="delete-btn" onclick="deleteItem('${type}', '${docSnap.id}')">üóëÔ∏è</button>
          </div>`;
        list.appendChild(div);
      });
    } catch (err) {
      console.error("Error loading history:", err);
      list.innerHTML = "<p>Failed to load data.</p>";
    }
  }

  function closeHistory() {
    document.getElementById("historySection").style.display = "none";
  }

  async function deleteItem(type, id) {
    if (!confirm(`Are you sure you want to delete this ${type}?`)) return;
    try {
      await deleteDoc(doc(db, type, id));
      document.querySelector(`.history-item button[onclick*='${id}']`).closest(".history-item").remove();
      const statId = type === "events" ? "statEvents" : "statPolls";
      const current = parseInt(document.getElementById(statId).textContent);
      document.getElementById(statId).textContent = Math.max(0, current - 1);
      alert(`${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully!`);
    } catch (err) {
      console.error(`Error deleting ${type}:`, err);
      alert("Failed to delete item.");
    }
  }

  /* =========  UPLOAD EVENT ========= */
async function uploadEvent() {
  const title = document.getElementById("eventTitle").value.trim();
  const date = document.getElementById("eventDate").value.trim();
  const desc = document.getElementById("eventDesc").value.trim();

  if (!title || !date || !desc) return alert("Please fill all fields!");

  try {
    await addDoc(collection(db, "events"), { 
      title, 
      date, 
      description: desc, 
      createdAt: new Date().toISOString() 
    });

    alert("Event uploaded successfully!");

    // Clear inputs
    document.getElementById("eventTitle").value = "";
    document.getElementById("eventDate").value = "";
    document.getElementById("eventDesc").value = "";

    updateDashboardCounts();

    //  Redirect to events.html
    window.location.href = "events.html";
  } catch (err) {
    console.error("Error uploading event:", err);
    alert("Failed to upload event. Check console for details.");
  }
}


 /* =========  UPLOAD POLL ========= */
async function uploadPoll() {
  const question = document.getElementById("pollQuestion").value.trim();
  const options = document.getElementById("pollOptions").value
    .split(",")
    .map(o => o.trim())
    .filter(o => o);

  if (!question || options.length < 2)
    return alert("Enter a question and at least 2 options!");

  try {
    await addDoc(collection(db, "polls"), { 
      question, 
      options, 
      createdAt: new Date().toISOString() 
    });

    alert("Poll uploaded successfully!");

    // Clear inputs and preview
    document.getElementById("pollQuestion").value = "";
    document.getElementById("pollOptions").value = "";
    document.getElementById("previewPoll").innerHTML = 
      "<p style='color:#999;'>Start typing to preview your poll...</p>";

    updateDashboardCounts();

    // ‚úÖ Redirect to polls.html
    window.location.href = "polls.html";
  } catch (err) {
    console.error("Error uploading poll:", err);
    alert("Failed to upload poll. Check console for details.");
  }
}

/* ========= LIVE POLL PREVIEW ========= */
const pollQuestionInput = document.getElementById("pollQuestion");
const pollOptionsInput = document.getElementById("pollOptions");
const previewDiv = document.getElementById("previewPoll");

function updatePollPreview() {
  const question = pollQuestionInput.value.trim();
  const options = pollOptionsInput.value
    .split(",")
    .map(o => o.trim())
    .filter(o => o);

  if (!question) {
    previewDiv.innerHTML =
      "<p style='color:#999;'>Start typing to preview your poll...</p>";
    return;
  }

  let previewHTML = `
    <div style="
      background:#fff;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
      padding:16px 20px;
      margin-top:16px;
      max-width:500px;
    ">
      <h4 style="color:#d62300; font-size:17px; margin-bottom:10px;">${question}</h4>
      <div style="display:flex; flex-direction:column; gap:8px;">
  `;

  options.forEach(opt => {
    previewHTML += `
      <button style="
        background:#fff;
        border:1.5px solid #ff6600;
        border-radius:8px;
        padding:8px 12px;
        text-align:left;
        cursor:pointer;
        font-size:14px;
        color:#333;
        transition:0.2s;
      " onmouseover="this.style.background='#ff6600'; this.style.color='#fff';"
         onmouseout="this.style.background='#fff'; this.style.color='#333';">
        ${opt}
      </button>
    `;
  });

  previewHTML += `
      </div>
      <small style="color:#777; font-size:12px; display:block; margin-top:8px;">
        Preview only ‚Äî users can vote on Polls page.
      </small>
    </div>
  `;

  previewDiv.innerHTML = previewHTML;
}

// Listen for typing
pollQuestionInput.addEventListener("input", updatePollPreview);
pollOptionsInput.addEventListener("input", updatePollPreview);

// Default message
previewDiv.innerHTML =
  "<p style='color:#999;'>Start typing to preview your poll...</p>";


  /* =========  LOAD USERS ========= */
  async function loadUsers() {
    const table = document.getElementById("usersTableBody");
    table.innerHTML = "";
    const snap = await getDocs(collection(db, "users"));
    snap.forEach(doc => {
      const u = doc.data();
      table.innerHTML += `<tr><td>${u.name || "N/A"}</td><td>${u.email || "N/A"}</td><td>${u.role || "user"}</td></tr>`;
    });
    document.getElementById("statUsers").innerText = snap.size;
  }

  /* ========= üë§ ADMIN PROFILE ========= */
  const profileName = document.querySelector(".profile-name");
  const profileEmail = document.querySelector(".profile-email");
  const profileAvatar = document.querySelector(".profile-avatar");

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      profileName.textContent = user.displayName || "Admin";
      profileEmail.textContent = user.email || "";
      profileAvatar.textContent = (user.displayName?.charAt(0) || "A").toUpperCase();
    } else {
      alert("You are not logged in! Redirecting...");
      window.location.href = "login.html";
    }
  });

  /* ========= EDIT / SWITCH / LOGOUT ========= */
  window.editDetails = async function () {
    const newName = prompt("Enter your new name:");
    if (!newName) return;
    const user = auth.currentUser;
    if (!user) return alert("No user logged in.");

    try {
      await updateProfile(user, { displayName: newName });
      profileName.textContent = newName;
      profileAvatar.textContent = newName.charAt(0).toUpperCase();
      alert("Name updated successfully!");
    } catch (error) {
      alert("Failed to update name: " + error.message);
    }
  };

  window.switchAccount = async function () {
    if (confirm("Switch account? You will be logged out.")) {
      await signOut(auth);
      window.location.href = "login.html";
    }
  };

  window.logoutAdmin = async function () {
    if (confirm("Are you sure you want to log out?")) {
      await signOut(auth);
      alert("Logged out successfully!");
      window.location.href = "login.html";
    }
  };

  /* ========= GLOBAL ACCESS FOR BUTTONS ========= */
  window.uploadEvent = uploadEvent;
  window.uploadPoll = uploadPoll;
  window.loadUsers = loadUsers;
  window.showHistory = showHistory;
  window.closeHistory = closeHistory;
  window.deleteItem = deleteItem;
  window.updateDashboardCounts = updateDashboardCounts;
</script>
<script>
  /* ===== SIDEBAR PAGE SWITCH ===== */
  function showPage(page, e) {
    document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
    document.querySelectorAll(".page").forEach(p => (p.style.display = "none"));
    document.querySelector(`#page-${page}`).style.display = "block";
    e.target.closest("a").classList.add("active");

    if (page === "users") loadUsers();
    if (page === "dashboard") updateDashboardCounts();
  }

  /* ===== üë§ PROFILE DROPDOWN TOGGLE ===== */
  const adminProfile = document.getElementById("adminProfile");
  const profileDropdown = document.getElementById("profileDropdown");

  adminProfile.addEventListener("click", (e) => {
    e.stopPropagation();
    const visible = profileDropdown.style.display === "block";
    profileDropdown.style.display = visible ? "none" : "block";
  });

  document.addEventListener("click", (e) => {
    if (!adminProfile.contains(e.target)) profileDropdown.style.display = "none";
  });
</script>

</body>
</html>
