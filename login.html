<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Login | Campus Bites</title>
    <link rel="icon" href="img/core-img/campus-bites.jpg">
    <link href="style.css" rel="stylesheet">
    <link href="css/responsive/responsive.css" rel="stylesheet">
    <style>
        #login .card {
            background-color: #fff;
            border-radius: 15px;
            transition: 0.3s;
        }
        #login .card:hover {
            transform: scale(1.02);
        }
        #login input.form-control {
        border-radius: 10px;
        }
        #login button.btn {
            border-radius: 10px;
            transition: 0.3s;
            background-color: #d62300;
            color: #fff;
        }
        #login button.btn:hover {
            background-color: #b91e00;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <header class="header_area">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="logo_area text-center" style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                      <img src="img/bg-img/canteen review logo (white).jpg" alt="logo" style="height: 90px; width: auto; object-fit: contain;">
                      <a href="index.html" class="yummy-logo" style="font-size: 46px; text-decoration: none; color: #000; font-weight: 500;">Campus Bites</a>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <nav class="navbar navbar-expand-lg">
                        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#yummyfood-nav" aria-controls="yummyfood-nav" aria-expanded="false" aria-label="Toggle navigation"><i class="fa fa-bars" aria-hidden="true"></i> Menu</button>
                        <div class="collapse navbar-collapse justify-content-center" id="yummyfood-nav">
                            <ul class="navbar-nav" id="yummy-nav">
                                <li class="nav-item">
                                    <a class="nav-link" href="index.html">Home<span class="sr-only">(current)</span></a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="branch.html">Branch</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="events.html">Events</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="poll.html">Poll</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="leaderboard.html">Leaderboard</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="profile.html">Profile</a>
                                </li>
                            </ul>
                        </div>
                    </nav>
                </div>
            </div>
        </div>
    </header>
  <section id="login" class="d-flex align-items-center justify-content-center" style="min-height: 60vh; background: #fff8f3;">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-5 col-md-7">
        <div class="card shadow-lg border-0 rounded-4">
          <div class="card-body p-4">
            <p class="text-center text-muted mb-4">Log in to your account</p>
            <form id="login-form">
              <div class="form-group mb-3">
                <label for="email">Email Address</label>
                <input type="email" name="email" class="form-control" placeholder="Enter your email" required>
              </div>
              <div class="form-group mb-3" style="position: relative;">
                <label for="password">Password</label>
                <input type="password" name="password" class="form-control" id="password" placeholder="Enter your password" required>
                <i class="fa fa-eye" id="togglePassword" style="position: absolute; right: 15px; top: 38px; cursor: pointer; color: #d62300;"></i>
              </div>

              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <input type="checkbox" name="remember" id="remember">
                  <label for="remember">Remember Me</label>
                </div>
                <a href="forgot-password.html" class="text-decoration-none text-danger">Forgot Password?</a>
              </div>
              <button type="submit" class="btn w-100">Login</button>
            </form>

            <p class="text-center mt-4 mb-0">
              Don’t have an account?
              <a href="register.html" class="text-danger fw-semibold">Sign up here</a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<footer id="footer" class="footer mt-auto py-3" style="background-color:#fff0ea;">
  <div class="container text-center">
    <p class="mb-0" style="color:#333;">
      &copy; 2025 <strong><span>Campus Bites</span></strong>. All Rights Reserved
    </p>
    <p class="mt-1 small" style="color:#d62300;">Made with ❤️ for campus foodies</p>
  </div>
</footer>
    <!-- Jquery-2.2.4 js -->
    <script src="js/jquery/jquery-2.2.4.min.js"></script>
    <!-- Popper js -->
    <script src="js/bootstrap/popper.min.js"></script>
    <!-- Bootstrap-4 js -->
    <script src="js/bootstrap/bootstrap.min.js"></script>
    <!-- All Plugins JS -->
    <script src="js/others/plugins.js"></script>
    <!-- Google Maps -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAwuyLRa1uKNtbgx6xAJVmWy-zADgegA2s"></script>
    <script src="js/google-map/map-active.js"></script>
    <!-- Active JS -->
    <script src="js/active.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getAuth, 
  signInWithEmailAndPassword, 
  setPersistence, 
  browserLocalPersistence, 
  browserSessionPersistence, 
  sendPasswordResetEmail 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBy5yfr3yYuMSDFHWwp0LdRhQASe2EKx78",
  authDomain: "campusbites-a7d47.firebaseapp.com",
  projectId: "campusbites-a7d47",
  storageBucket: "campusbites-a7d47.appspot.com",
  messagingSenderId: "287799383807",
  appId: "1:287799383807:web:80dcc43f75b5e226241eca"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginForm = document.getElementById("login-form");
const rememberCheckbox = document.getElementById("remember");
const forgotLink = document.querySelector('a[href="forgot-password.html"]');

//Add role dropdown visibly before submit button if missing
if (!loginForm.querySelector('select[name="role"]')) {
  const roleDiv = document.createElement("div");
  roleDiv.classList.add("form-group", "mb-3");
  roleDiv.innerHTML = `
    <label for="role">Role</label>
    <select name="role" class="form-select" required>
      <option value="" disabled selected>Select your role</option>
      <option value="student">Student</option>
      <option value="faculty">Faculty</option>
      <option value="admin">Admin</option>
    </select>`;
  loginForm.insertBefore(roleDiv, loginForm.querySelector("button.btn"));
}

loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const email = loginForm.email.value.trim().toLowerCase();
  const password = loginForm.password.value.trim();
  const role = loginForm.role.value;

  if (!role) {
    Swal.fire({
      icon: "warning",
      title: "Select your role!",
      text: "Please choose Student, Faculty, or Admin before logging in.",
    });
    return;
  }

  const allowedDomains = ["nmims.in", "nmims.edu.in"];
  const domain = email.split("@")[1];
  if (!allowedDomains.includes(domain)) {
    Swal.fire({
      icon: "error",
      title: "Invalid Email!",
      text: "Please use your NMIMS email (nmims.in or nmims.edu.in).",
    });
    return;
  }

  const persistenceType = rememberCheckbox?.checked
    ? browserLocalPersistence
    : browserSessionPersistence;

  try {
    await setPersistence(auth, persistenceType);
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;

    //Admin verification
    if (role === "admin") {
      const adminId = email.split("@")[0]; // e.g. "admin1"
      const adminRef = doc(db, "users", adminId);
      const adminSnap = await getDoc(adminRef);

      if (!adminSnap.exists()) {
        Swal.fire({
          icon: "error",
          title: "Access Denied!",
          text: "This account does not have admin privileges.",
        });
        return;
      }

      Swal.fire({
        icon: "success",
        title: `Welcome, ${adminSnap.data().name}!`,
        text: "Redirecting to Admin Dashboard...",
        showConfirmButton: false,
        timer: 2000,
      }).then(() => {
        window.location.href = "admin.html";
      });
      return;
    }

    //Normal student/faculty flow
    const userRef = doc(db, "loggedInUsers", user.uid);
    let userSnap = await getDoc(userRef);
    if (!userSnap.exists()) {
      await setDoc(userRef, {
        name: user.displayName || "User",
        email: user.email,
        role: role,
        username: user.email.split("@")[0],
        createdAt: new Date(),
      });
      userSnap = await getDoc(userRef);
    }

    Swal.fire({
      icon: "success",
      title: `Welcome back, ${userSnap.data().name}!`,
      text: `Logged in as ${role.toUpperCase()}`,
      showConfirmButton: false,
      timer: 2000,
    }).then(() => {
      window.location.href = "index.html";
    });

  } catch (error) {
    console.error("Login Error:", error);
    let message = "An unexpected error occurred.";
    if (error.code === "auth/user-not-found") message = "No user found with this email.";
    if (error.code === "auth/wrong-password") message = "Incorrect password. Try again.";

    Swal.fire({
      icon: "error",
      title: "Login Failed!",
      text: message,
    });
  }
});

//Forgot password
forgotLink.addEventListener("click", async (e) => {
  e.preventDefault();
  const email = prompt("Enter your NMIMS email to reset password:");
  if (!email) return;
  const allowedDomains = ["nmims.in", "nmims.edu.in"];
  const domain = email.split("@")[1];
  if (!allowedDomains.includes(domain)) {
    Swal.fire({
      icon: "error",
      title: "Invalid Email!",
      text: "Please use your NMIMS email (nmims.in or nmims.edu.in).",
    });
    return;
  }
  try {
    await sendPasswordResetEmail(auth, email);
    Swal.fire({
      icon: "success",
      title: "Email Sent!",
      text: "Password reset link sent to your NMIMS inbox (check spam too).",
    });
  } catch (error) {
    Swal.fire({
      icon: "error",
      title: "Error!",
      text: error.message,
    });
  }
});
</script>
<script>
  const togglePassword = document.querySelector("#togglePassword");
  const password = document.querySelector("#password");

  togglePassword.addEventListener("click", function () {
    const type = password.getAttribute("type") === "password" ? "text" : "password";
    password.setAttribute("type", type);
    this.classList.toggle("fa-eye-slash"); // toggles icon style
  });
</script>
</body>
</html>
