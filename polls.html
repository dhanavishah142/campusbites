<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="description" content="">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Campus Bites | Polls</title>
  <link rel="icon" href="img/core-img/campus-bites.jpg">
  <link href="style.css" rel="stylesheet">
  <link href="css/responsive/responsive.css" rel="stylesheet">
  <style>
    #polls {
      background-color: #fff8f3;
      padding: 80px 0;
    }
    .poll-option {
  background-color: #f5f5f5;
  border: 2px solid #ddd;
  border-radius: 12px;
  padding: 10px 15px;
  margin: 8px 0;
  cursor: pointer;
  transition: 0.3s;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 500;
}

.poll-option:hover {
  background-color: #ffeae3;
  border-color: #d62300;
}

.poll-option.selected {
  background-color: #d62300;
  color: white;
  border-color: #d62300;
}

.poll-option .percent {
  font-size: 14px;
  color: #333;
}

.poll-option.selected .percent {
  color: white;
}

    #polls .poll-card {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: 0.3s;
      padding: 30px;
      margin-bottom: 30px;
    }

    #polls .poll-card:hover {
      transform: scale(1.02);
    }

    #polls h4 {
      color: #d62300;
      font-weight: 600;
    }

    #polls label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      cursor: pointer;
    }

    #polls button {
      background-color: #d62300;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 8px 20px;
      transition: 0.3s;
    }

    #polls button:hover {
      background-color: #b91e00;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <header class="header_area">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <div class="logo_area text-center" style="display: flex; align-items: center; justify-content: center; gap: 15px;">
            <img src="img/bg-img/canteen review logo (white).jpg" alt="logo" style="height: 90px; width: auto; object-fit: contain;">
            <a href="index.html" class="yummy-logo" style="font-size: 46px; text-decoration: none; color: #000; font-weight: 500;">Campus Bites</a>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <nav class="navbar navbar-expand-lg">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#yummyfood-nav" aria-controls="yummyfood-nav" aria-expanded="false" aria-label="Toggle navigation"><i class="fa fa-bars" aria-hidden="true"></i> Menu</button>
            <div class="collapse navbar-collapse justify-content-center" id="yummyfood-nav">
              <ul class="navbar-nav" id="yummy-nav">
                <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="branch.html">Branch</a></li>
                <li class="nav-item"><a class="nav-link" href="events.html">Events</a></li>
                <li class="nav-item active"><a class="nav-link" href="polls.html">Polls</a></li>
                <li class="nav-item"><a class="nav-link" href="leaderboard.html">Leaderboard</a></li>
                <li class="nav-item"><a class="nav-link" href="profile.html">Profile</a></li>
              </ul>
            </div>
          </nav>
        </div>
      </div>
    </div>
  </header>

  <section id="polls">
    <div class="container">
      <div class="text-center mb-5">
        <h2 style="color:#d62300;">Vote for Your Campus Favorites</h2>
        <p class="text-muted">Choose your favorite options below and make your voice heard!</p>
      </div>

      <div class="row g-4 justify-content-center">
        <div class="col-lg-6 col-md-8">
          <div class="poll-card">
            <div class="poll" id="poll1">
              <h4>Which is the best evening snack?</h4>
              <div class="poll-option" data-value="Vada Pav">Vada Pav <span class="percent"></span></div>
              <div class="poll-option" data-value="Maggi">Maggi <span class="percent"></span></div>
              <div class="poll-option" data-value="Sandwich">Grilled Sandwich <span class="percent"></span></div>
              <div class="poll-option" data-value="Pasta">Pasta <span class="percent"></span></div>
              <button type="button" class="vote-btn mt-3">Vote</button>
            </div>
          </div>
        </div>

        <div class="col-lg-6 col-md-8">
          <div class="poll-card">
            <div class="poll" id="poll2">
              <h4>Favorite beverage to grab during breaks?</h4>
              <div class="poll-option" data-value="Tea">Tea <span class="percent"></span></div>
              <div class="poll-option" data-value="Coffee">Coffee <span class="percent"></span></div>
              <div class="poll-option" data-value="Cold Coffee">Cold Coffee <span class="percent"></span></div>
              <div class="poll-option" data-value="Diet Coke">Diet Coke <span class="percent"></span></div>
              <button type="button" class="vote-btn mt-3">Vote</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer id="footer" class="footer mt-auto py-3" style="background-color:#fff0ea;">
    <div class="container text-center">
      <p class="mb-0" style="color:#333;">
        &copy; 2025 <strong><span>Campus Bites</span></strong>. All Rights Reserved
      </p>
      <p class="mt-1 small" style="color:#d62300;">Made with ‚ù§Ô∏è for campus foodies</p>
    </div>
  </footer>

  <!-- JS -->
  <script src="js/jquery/jquery-2.2.4.min.js"></script>
  <script src="js/bootstrap/popper.min.js"></script>
  <script src="js/bootstrap/bootstrap.min.js"></script>
  <script src="js/others/plugins.js"></script>
  <script src="js/active.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, collection, getDocs, addDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { 
      getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
const firebaseConfig = {
  apiKey: "AIzaSyBy5yfr3yYuMSDFHWwp0LdRhQASe2EKx78",
  authDomain: "campusbites-a7d47.firebaseapp.com",
  projectId: "campusbites-a7d47",
  storageBucket: "campusbites-a7d47.appspot.com",
  messagingSenderId: "287799383807",
  appId: "1:287799383807:web:80dcc43f75b5e226241eca"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

//  Check login
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    Swal.fire({
      icon: "warning",
      title: "Login Required!",
      text: "You need to log in to access polls.",
      showConfirmButton: false,
      timer: 2000,
      didClose: () => {
        window.location.href = "login.html";
      }
    });
    return;
  }
  loadPolls(user.email);
});

// Load polls
async function loadPolls(userEmail) {
  const pollsContainer = document.querySelector(".row.g-4");
  pollsContainer.innerHTML = "";

  const snapshot = await getDocs(collection(db, "polls"));
  snapshot.forEach((docSnap) => {
    const poll = docSnap.data();
    const pollId = docSnap.id;

    const pollCard = document.createElement("div");
    pollCard.className = "col-lg-6 col-md-8";
    pollCard.innerHTML = `
      <div class="poll-card">
        <h4>${poll.question}</h4>
        <div id="${pollId}">
          ${poll.options.map(opt => `
            <div class="poll-option" data-value="${opt}">
              <span>${opt}</span>
              <span class="percent"></span>
            </div>`).join("")}
          <button class="vote-btn mt-3">Vote</button>
        </div>
      </div>
    `;
    pollsContainer.appendChild(pollCard);
    setupPoll(pollId, userEmail);
  });
}

// Setup poll logic
async function setupPoll(pollId, userEmail) {
  const pollDiv = document.getElementById(pollId);
  const options = pollDiv.querySelectorAll(".poll-option");
  const voteBtn = pollDiv.querySelector(".vote-btn");
  let selectedValue = null;

  options.forEach(opt => {
    opt.addEventListener("click", () => {
      options.forEach(o => o.classList.remove("selected"));
      opt.classList.add("selected");
      selectedValue = opt.dataset.value;
    });
  });

  voteBtn.addEventListener("click", async () => {
    if (!selectedValue) {
      Swal.fire({
        icon: "info",
        title: "Select an option!",
        text: "Please choose an option before voting.",
      });
      return;
    }

    const q = query(
      collection(db, "votes"),
      where("pollId", "==", pollId),
      where("user", "==", userEmail)
    );
    const existing = await getDocs(q);
    if (!existing.empty) {
      Swal.fire({
        icon: "error",
        title: "Already Voted!",
        text: "You have already voted in this poll.",
      });
      return;
    }

    await addDoc(collection(db, "votes"), {
      pollId,
      user: userEmail,
      choice: selectedValue,
      createdAt: new Date()
    });

    Swal.fire({
      icon: "success",
      title: "Vote Recorded!",
      text: "Thanks for sharing your choice üçΩÔ∏è",
      timer: 2000,
      showConfirmButton: false
    });

    showResults(pollId);
  });

  showResults(pollId);
}

// Show poll results
async function showResults(pollId) {
  const q = query(collection(db, "votes"), where("pollId", "==", pollId));
  const snapshot = await getDocs(q);
  const votes = snapshot.docs.map(d => d.data());
  if (votes.length === 0) return;

  const counts = {};
  votes.forEach(v => counts[v.choice] = (counts[v.choice] || 0) + 1);
  const total = votes.length;

  const pollDiv = document.getElementById(pollId);
  const options = pollDiv.querySelectorAll(".poll-option");

  options.forEach(opt => {
    const choice = opt.dataset.value;
    const percent = counts[choice] ? ((counts[choice] / total) * 100).toFixed(0) : 0;
    opt.querySelector(".percent").textContent = `${percent}%`;
    opt.style.background = `linear-gradient(90deg, #d62300 ${percent}%, #f5f5f5 ${percent}%)`;
  });
}
</script>
</body>
</html>
