<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leaderboard | Campus Bites</title>
  <link rel="icon" href="img/core-img/campus-bites.jpg">
  <link href="style.css" rel="stylesheet">
  <link href="css/responsive/responsive.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #fff8f7;
      font-family: 'Poppins', sans-serif;
    }
    .navbar {
      background-color: #b91e00;
    }
    .navbar .nav-link {
      color: white !important;
      font-weight: 500;
    }
    .navbar .nav-link:hover {
      text-decoration: underline;
    }
    .leaderboard-section {
      padding: 60px 0;
      text-align: center;
    }
    .leaderboard-section h2 {
      font-weight: 700;
      color: #b91e00;
      margin-bottom: 40px;
    }

    .leaderboard-card {
      border-radius: 20px;
      background: #fff;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      transition: 0.3s;
    }
    .leaderboard-card:hover {
      transform: scale(1.02);
    }
    .leaderboard-card .rank {
      font-size: 24px;
      font-weight: bold;
      color: #b91e00;
    }
    .leaderboard-card img {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
    }
    .leaderboard-card .name {
      font-size: 18px;
      font-weight: 600;
    }
    .leaderboard-card .points {
      font-size: 16px;
      color: #555;
    }
    footer {
      background-color: #b91e00;
      color: white;
      padding: 30px 0;
    }
    footer a {
      color: white;
      text-decoration: none;
    }
    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<body>
  <header class="header_area">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <div class="logo_area text-center" style="display: flex; align-items: center; justify-content: center; gap: 15px;">
            <img src="img/bg-img/canteen review logo.jpg" alt="logo" style="height: 90px; width: auto; object-fit: contain;">
            <a href="index.html" class="yummy-logo" style="font-size: 46px; text-decoration: none; color: #000; font-weight: 500;">Campus Bites</a>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <nav class="navbar navbar-expand-lg">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#yummyfood-nav" aria-controls="yummyfood-nav" aria-expanded="false" aria-label="Toggle navigation"><i class="fa fa-bars" aria-hidden="true"></i> Menu</button>
            <div class="collapse navbar-collapse justify-content-center" id="yummyfood-nav">
              <ul class="navbar-nav" id="yummy-nav">
                <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="branch.html">Branch</a></li>
                <li class="nav-item"><a class="nav-link" href="events.html">Events</a></li>
                <li class="nav-item active"><a class="nav-link" href="polls.html">Polls</a></li>
                <li class="nav-item"><a class="nav-link" href="leaderboard.html">Leaderboard</a></li>
                <li class="nav-item"><a class="nav-link" href="profile.html">Profile</a></li>
              </ul>
            </div>
          </nav>
        </div>
      </div>
    </div>
  </header>

  <!-- Leaderboard Section -->
  <!-- LEADERBOARD SECTION -->
<section class="leaderboard-section container mt-5">
  <!-- Loading Spinner -->
  <div id="leaderboard-loader" class="text-center py-5" style="display:none;">
    <div class="spinner-border text-danger" style="width:3rem; height:3rem;" role="status"></div>
    <p class="mt-3 text-muted fs-5">Loading leaderboard...</p>
  </div>

  <!-- Leaderboard Content -->
  <div id="leaderboard-content">
    <!-- Top 3 Users -->
    <div class="row g-4 justify-content-center mb-4"></div>

    <!-- Remaining Users Table -->
    <div class="table-responsive">
      <table class="table table-striped align-middle text-center">
        <thead class="table-danger">
          <tr>
            <th>Rank</th>
            <th>Name</th>
            <th>Branch</th>
            <th>Points</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</section>

  <!-- Footer -->
  <footer class="text-center">
    <div class="container">
      <p>
  <a href="#" data-bs-toggle="modal" data-bs-target="#aboutModal">About Us</a> |
  <a href="#" data-bs-toggle="modal" data-bs-target="#creditsModal">Credits</a> |
  <a href="#" data-bs-toggle="modal" data-bs-target="#howToUseModal">How to Use</a>
</p>

      <p class="mb-0">&copy; 2025 Campus Bites. All rights reserved.</p>
    </div>
  </footer>
  <!-- About Us Modal -->
<div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="aboutModalLabel">About Campus Bites</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Campus Bites is your go-to college food companion! Discover top-rated canteens, share reviews, and engage in fun polls. Our goal is to make every student meal better, one bite at a time üçî.</p>
      </div>
    </div>
  </div>
</div>

<!-- Credits Modal -->
<div class="modal fade" id="creditsModal" tabindex="-1" aria-labelledby="creditsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="creditsModalLabel">Credits</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Designed and developed by Team Campus Bites using HTML, CSS, JavaScript, Bootstrap, and Firebase üíª.</p>
      </div>
    </div>
  </div>
</div>

<!-- How to Use Modal -->
<div class="modal fade" id="howToUseModal" tabindex="-1" aria-labelledby="howToUseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="howToUseModalLabel">How to Use Campus Bites</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul>
          <li>Browse canteen menus and reviews.</li>
          <li>Vote in food polls and share opinions.</li>
          <li>Earn points for writing reviews ‚Äî top reviewers get featured on the leaderboard!</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBy5yfr3yYuMSDFHWwp0LdRhQASe2EKx78",
  authDomain: "campusbites-a7d47.firebaseapp.com",
  projectId: "campusbites-a7d47",
  storageBucket: "campusbites-a7d47.appspot.com",
  messagingSenderId: "287799383807",
  appId: "1:287799383807:web:80dcc43f75b5e226241eca"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Show/Hide loading spinner
function toggleLoading(show = true) {
  const loader = document.getElementById("leaderboard-loader");
  if (loader) loader.style.display = show ? "block" : "none";
  const content = document.getElementById("leaderboard-content");
  if (content) content.style.display = show ? "none" : "block";
}

// Update review counts
async function updateReviewCounts() {
  const usersSnapshot = await getDocs(collection(db, "loggedInUsers"));
  const updatePromises = [];

  for (const userDoc of usersSnapshot.docs) {
    const reviewsSnapshot = await getDocs(
      collection(db, "loggedInUsers", userDoc.id, "reviews")
    );
    const reviewCount = reviewsSnapshot.size;
    updatePromises.push(
      updateDoc(doc(db, "loggedInUsers", userDoc.id), { reviewCount })
    );
  }

  await Promise.all(updatePromises);
}

// Login check
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    Swal.fire({
      title: "Login Required üîí",
      text: "Please log in to view the leaderboard.",
      icon: "warning",
      confirmButtonText: "Go to Login",
      confirmButtonColor: "#d62300",
      allowOutsideClick: false,
      backdrop: "rgba(0,0,0,0.6)"
    }).then(() => {
      window.location.href = "login.html";
    });
  } else {
    toggleLoading(true);
    await updateReviewCounts();
    await loadLeaderboard();
    toggleLoading(false);
  }
});

// Load leaderboard
async function loadLeaderboard() {
  const usersSnapshot = await getDocs(collection(db, "loggedInUsers"));
  const users = [];

  usersSnapshot.forEach((docSnap) => {
    const data = docSnap.data();
    if (!data.role || data.role.toLowerCase() === "student") {
      const name = data.name || data.displayName || "Unknown";
      const initials = name
        .split(" ")
        .map((n) => n[0]?.toUpperCase() || "")
        .join("")
        .slice(0, 2);
      let branchDisplay = data.branch || "Unknown";
      if (branchDisplay === "MPSTME") branchDisplay = "NMIMS MPSTME";
      users.push({
        name,
        initials,
        branch: branchDisplay,
        points: (data.reviewCount || 0) * 10
      });
    }
  });

  users.sort((a, b) => b.points - a.points);

  const top3Container = document.querySelector(".row.g-4.justify-content-center");
  const tableBody = document.querySelector("tbody");
  if (!top3Container || !tableBody) return;

  top3Container.innerHTML = "";
  tableBody.innerHTML = "";

  const medals = ["ü•á", "ü•à", "ü•â"];
  users.slice(0, 3).forEach((user, index) => {
    top3Container.innerHTML += `
      <div class="col-md-4">
        <div class="leaderboard-card p-4 text-center">
          <div class="rank">${medals[index]} #${index + 1}</div>
          <div class="circle bg-danger text-white d-flex align-items-center justify-content-center mx-auto mt-3"
              style="width: 70px; height: 70px; border-radius: 50%; font-size: 22px; font-weight: bold;">
            ${user.initials}
          </div>
          <div class="name mt-3">${user.name}</div>
          <div class="points">‚≠ê ${user.points} Points</div>
        </div>
      </div>
    `;
  });

  users.slice(3).forEach((user, i) => {
    tableBody.innerHTML += `
      <tr>
        <td>#${i + 4}</td>
        <td>${user.name}</td>
        <td>${user.branch}</td>
        <td>${user.points}</td>
      </tr>
    `;
  });
}
</script>
</body>
</html>
